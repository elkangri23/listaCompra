generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id                 String      @id @default(uuid())
  email              String      @unique
  password           String
  nombre             String
  apellidos          String?
  rol                RolUsuario  @default(USUARIO)
  activo             Boolean     @default(true)
  emailVerificado    Boolean     @default(false)
  fechaCreacion      DateTime    @default(now())
  fechaActualizacion DateTime    @updatedAt
  blueprints         Blueprint[]
  listas             Lista[]
  permisos           Permiso[]
  productos          Producto[]

  @@map("usuarios")
}

model Lista {
  id                 String       @id @default(uuid())
  nombre             String
  descripcion        String?
  color              String?
  icono              String?
  activa             Boolean      @default(true)
  fechaCreacion      DateTime     @default(now())
  fechaActualizacion DateTime     @updatedAt
  propietarioId      String
  invitaciones       Invitacion[]
  propietario        Usuario      @relation(fields: [propietarioId], references: [id])
  permisos           Permiso[]
  productos          Producto[]

  @@map("listas")
}

model Producto {
  id                 String     @id @default(uuid())
  nombre             String
  descripcion        String?
  cantidad           Int        @default(1)
  unidad             String?
  precio             Decimal?
  comprado           Boolean    @default(false)
  urgente            Boolean    @default(false)
  fechaCreacion      DateTime   @default(now())
  fechaActualizacion DateTime   @updatedAt
  fechaCompra        DateTime?
  listaId            String
  categoriaId        String?
  creadoPorId        String
  categoria          Categoria? @relation(fields: [categoriaId], references: [id])
  creadoPor          Usuario    @relation(fields: [creadoPorId], references: [id])
  lista              Lista      @relation(fields: [listaId], references: [id], onDelete: Cascade)

  @@map("productos")
}

model Categoria {
  id                 String     @id @default(uuid())
  nombre             String
  descripcion        String?
  color              String?
  icono              String?
  activa             Boolean    @default(true)
  fechaCreacion      DateTime   @default(now())
  fechaActualizacion DateTime   @updatedAt
  tiendaId           String?
  tienda             Tienda?    @relation(fields: [tiendaId], references: [id])
  productos          Producto[]

  @@unique([nombre, tiendaId])
  @@map("categorias")
}

model Tienda {
  id                 String      @id @default(uuid())
  nombre             String      @unique
  direccion          String?
  telefono           String?
  sitioWeb           String?
  activa             Boolean     @default(true)
  fechaCreacion      DateTime    @default(now())
  fechaActualizacion DateTime    @updatedAt
  categorias         Categoria[]

  @@map("tiendas")
}

model Invitacion {
  id              String      @id @default(uuid())
  hash            String      @unique
  fechaCreacion   DateTime    @default(now())
  fechaExpiracion DateTime
  listaId         String
  activa          Boolean     @default(true)
  tipoPermiso     TipoPermiso @default(LECTURA)
  lista           Lista       @relation(fields: [listaId], references: [id], onDelete: Cascade)

  @@map("invitaciones")
}

model Permiso {
  id            String      @id @default(uuid())
  fechaCreacion DateTime    @default(now())
  usuarioId     String
  listaId       String
  tipoPermiso   TipoPermiso
  lista         Lista       @relation(fields: [listaId], references: [id], onDelete: Cascade)
  usuario       Usuario     @relation(fields: [usuarioId], references: [id])

  @@unique([usuarioId, listaId])
  @@map("permisos")
}

model Blueprint {
  id                 String   @id @default(uuid())
  nombre             String
  descripcion        String?
  publico            Boolean  @default(false)
  contenido          Json
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt
  creadoPorId        String
  creadoPor          Usuario  @relation(fields: [creadoPorId], references: [id])

  @@map("blueprints")
}

model OutboxEvent {
  id            String    @id @default(uuid())
  aggregateId   String
  eventType     String
  eventData     Json
  processed     Boolean   @default(false)
  attempts      Int       @default(0)
  aggregateType String
  createdAt     DateTime  @default(now())
  eventContext  Json?
  eventId       String    @unique
  eventVersion  Int       @default(1)
  lastAttemptAt DateTime?
  lastError     String?
  occurredOn    DateTime
  processedAt   DateTime?
  updatedAt     DateTime  @updatedAt

  @@index([processed, createdAt])
  @@index([eventType, processed])
  @@index([aggregateId, aggregateType])
  @@index([occurredOn])
  @@map("outbox_events")
}

model AuditEntry {
  id              String    @id @default(uuid())
  entityType      String    // e.g., 'Lista', 'Producto'
  entityId        String    // ID of the entity that was changed
  changeType      String    // e.g., 'CREATE', 'UPDATE', 'DELETE'
  changedByUserId String?   // ID of the user who made the change (optional, for system changes)
  timestamp       DateTime  @default(now())
  oldValue        Json?     // JSON representation of the entity before the change
  newValue        Json?     // JSON representation of the entity after the change
  changedFields   Json?     // JSON array of strings indicating which fields were modified

  @@index([entityType, entityId])
  @@index([changedByUserId])
  @@index([timestamp])
  @@map("audit_entries")
}

enum RolUsuario {
  USUARIO
  ADMIN
}

enum TipoPermiso {
  LECTURA
  ESCRITURA
  ADMIN
}
